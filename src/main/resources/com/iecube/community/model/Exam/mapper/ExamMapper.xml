<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iecube.community.model.Exam.mapper.ExamMapper">

    <resultMap id="ExamQuesContentResultMap" type="com.iecube.community.model.Exam.entity.QuesContentEntity">
        <id column="content_id" property="id"/>
        <result column="content_p_id" property="pId"/>
        <result column="title" property="title"/>
        <result column="options_string" property="optionsString"/>
        <result column="answer" property="answer"/>
        <result column="knowledge_str" property="knowledgeStr"/>
    </resultMap>

    <resultMap id="ExamQuestionResultMap" type="com.iecube.community.model.Exam.entity.QuestionEntity">
        <id column="question_id" property="id"/>
        <result column="question_p_id" property="pId"/>
        <result column="ques_type" property="quesType"/>
        <result column="order" property="order"/>
        <result column="is_random" property="isRandom"/>
        <result column="random_num" property="randomNum"/>
        <result column="difficulty" property="difficulty"/>
        <result column="score" property="score"/>
        <!-- 嵌套题目内容列表 -->
        <collection property="examQuesContents" ofType="com.iecube.community.model.Exam.entity.QuesContentEntity"
                    resultMap="ExamQuesContentResultMap"/>
    </resultMap>

    <resultMap id="ExamInfoWithAllResultMap" type="com.iecube.community.model.Exam.entity.ExamInfoEntity">
        <id column="exam_id" property="id"/>
        <result column="project_id" property="projectId"></result>
        <result column="total_score" property="totalScore"></result>
        <result column="pass_score" property="passScore"></result>
        <result column="start_time" property="startTime"></result>
        <result column="end_time" property="endTime"></result>
        <result column="use_random_option" property="useRandomOption"></result>
        <result column="use_random_question" property="useRandomQuestion"></result>
        <result column="ai_auto_check" property="aiAutoCheck"></result>
        <result column="create_time" property="createTime"></result>
        <result column="last_modified_user" property="lastModifiedUser"></result>
        <result column="last_modified_time" property="lastModifiedTime"></result>
        <result column="use_random_option" property="useRandomOption"></result>
        <result column="use_random_question" property="useRandomQuestion"></result>
        <result column="ai_auto_check" property="aiAutoCheck"></result>
        <!-- 嵌套题目列表 -->
        <collection property="examQuestions" ofType="com.iecube.community.model.Exam.entity.ExamInfoEntity"
                    resultMap="ExamQuestionResultMap"/>
    </resultMap>

    <resultMap id="ExamCourseVo" type="com.iecube.community.model.Exam.vo.ExamCourseVo">
        <result column="id" property="projectId"/>
        <result column="project_name" property="projectName"/>
        <result column="create_time" property="createTime"/>
        <result column="stu_num" property="stuNum"/>
    </resultMap>

    <resultMap id="ExamStudent" type="com.iecube.community.model.Exam.entity.ExamStudent">
        <result column="es_id" property="id" />
        <result column="exam_id" property="examId" />
        <result column="student_id" property="studentId" />
        <result column="score" property="score" />
        <result column="ai_score" property="aiScore" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
    </resultMap>

    <resultMap id="ExamWithStudentDto" type="com.iecube.community.model.Exam.Dto.ExamWithStudentDto">
        <id column="exam_id" property="id"/>
        <result column="project_id" property="projectId" />
        <result column="project_name" property="projectName" />
        <result column="semester" property="semester" />
        <result column="name" property="name" />
        <result column="duration" property="duration" />
        <result column="total_score" property="totalScore" />
        <result column="pass_score" property="passScore" />
        <result column="exam_start_time" property="startTime" />
        <result column="exam_end_time" property="endTime" />
        <collection property="examStudentList"  ofType="com.iecube.community.model.Exam.Dto.ExamWithStudentDto"
                    resultMap="ExamStudent"/>
    </resultMap>

    <resultMap id="ExamStudentVo" type="com.iecube.community.model.Exam.vo.ExamStudentVo">
        <result column="id" property="esId"/>
        <result column="s_id" property="studentId"/>
        <result column="exam_id" property="examId"/>
        <result column="student_id" property="stuId"/>
        <result column="student_name" property="stuName"/>
        <result column="score" property="score"/>
        <result column="remark" property="remark"/>
        <result column="ai_score" property="aiScore"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
    </resultMap>

    <resultMap id="ExamPaper" type="com.iecube.community.model.Exam.entity.ExamPaper">
        <result column="id" property="id"/>
        <result column="es_id" property="esId"/>
        <result column="ques_type" property="quesType"/>
        <result column="total_score" property="totalScore"/>
        <result column="options_string" property="optionsString"/>
        <result column="knowledge_str" property="knowledgeStr"/>
        <result column="ai_score" property="aiScore"/>
        <result column="payload_str" property="payloadStr"/>
    </resultMap>

    <insert id="insertExamEntity" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO
            ExamInfo (`id`, `project_id`, `name`, `duration`, `total_score`, `pass_score`, `start_time`,
                      `end_time`, `create_time`, `creator`, `last_modified_user`, `last_modified_time`,
                      `use_random_option`, `use_random_question`, `ai_auto_check`)
        VALUES (NULL, #{projectId}, #{name}, #{duration}, #{totalScore}, #{passScore}, #{startTime},
                #{endTime}, #{createTime}, #{creator}, #{lastModifiedUser}, #{lastModifiedTime},
                #{useRandomOption}, #{useRandomQuestion}, #{aiAutoCheck})
    </insert>

    <delete id="delExamById">
        DELETE FROM ExamInfo WHERE id=#{id}
    </delete>

    <insert id="batchInsertQuestion">
        INSERT INTO
            Exam_question (`id`, `p_id`, `ques_type`, `order`, `is_random`, `random_num`, `difficulty`, `score`)
        VALUES
            <foreach collection="list" separator="," item="item">
                (
                 #{item.id}, #{item.pId}, #{item.quesType}, #{item.order}, #{item.isRandom},
                 #{item.randomNum}, #{item.difficulty}, #{item.score}
                )
            </foreach>
    </insert>

    <insert id="batchInsertQuesContent">
        INSERT INTO Exam_ques_content  (`id`, `p_id`, `title`, `options_string`, `answer`, `knowledge_str`)
        VALUES
            <foreach collection="list" separator="," item="item">
                (
                 #{item.id}, #{item.pId}, #{item.title}, #{item.optionsString}, #{item.answer},
                 #{item.knowledgeStr}
                )
            </foreach>
    </insert>

    <!-- 核心SQL：一次联表查询所有数据 -->
    <select id="selectExamWithQuestionsAndContent" resultMap="ExamInfoWithAllResultMap">
        SELECT
            ei.`id` AS exam_id,
            ei.`project_id`,
            ei.`name`,
            ei.`duration`,
            ei.`total_score`,
            ei.`pass_score`,
            ei.`start_time`,
            ei.`end_time`,
            ei.`create_time`,
            ei.`creator`,
            ei.`last_modified_user`,
            ei.`last_modified_time`,
            ei.`use_random_option`,
            ei.`use_random_question`,
            ei.`ai_auto_check`,
            eq.`id` AS question_id,
            eq.`p_id` AS question_p_id,
            eq.`ques_type`,
            eq.`order`,
            eq.`is_random`,
            eq.`random_num`,
            eq.`difficulty`,
            eq.`score`,
            eqc.`id` AS content_id,
            eqc.`p_id` AS content_p_id,
            eqc.`title`,
            eqc.`options_string`,
            eqc.`answer`,
            eqc.`knowledge_str`
        FROM ExamInfo ei
                 LEFT JOIN Exam_question eq ON ei.`id` = eq.`p_id`
                 LEFT JOIN Exam_ques_content eqc ON eq.`id` = eqc.`p_id`
        WHERE ei.`id` = #{id}
        ORDER BY eq.`ques_type`, eq.`order` ASC; -- 按题目排序，保证顺序一致
    </select>

    <select id="selectProjectStudentId" resultType="java.lang.Integer">
        SELECT `student_id` FROM EMDV4_projectStudent WHERE `project_id`=#{projectId};
    </select>

    <insert id="batchInsertExamStudent" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO Exam_student (`id`, `exam_id`, `student_id`, `score`, `ai_score`, `start_time` ,`end_time`)
        VALUES
            <foreach collection="list" separator="," item="item">
                (NULL, #{item.examId}, #{item.studentId}, 0.00, 0.00, #{item.startTime}, #{item.endTime})
            </foreach>
    </insert>

    <insert id="batchInsertExamPaper">
        INSERT INTO Exam_paper (`id`, `es_id`, `ques_type`, `order`, `total_score`, `score`, `title`, `options_string`,
                                `answer`, `knowledge_str`, `response`)
        VALUES
            <foreach collection="list" separator="," item="item">
                (#{item.id}, #{item.esId}, #{item.quesType}, #{item.order}, #{item.totalScore}, #{item.score},
                 #{item.title}, #{item.optionsString}, #{item.answer}, #{item.knowledgeStr}, #{item.response})
            </foreach>
    </insert>

    <select id="selectTeacherExamCourse" resultMap="ExamCourseVo">
        SELECT
            p.id,
            p.project_name,
            p.semester,
            p.cover,
            p.create_time,
            COUNT(DISTINCT ps.id) AS stu_num
        FROM ExamInfo e
                 LEFT JOIN project p  ON e.project_id=p.id
                 LEFT JOIN EMDV4_projectStudent ps ON p.id=ps.project_id
        WHERE p.creator=#{creator} AND p.is_delete=0 AND p.version=4
        GROUP BY p.id
        ORDER BY create_time;
    </select>

    <select id="selectExamWithStudentDto" resultMap="ExamWithStudentDto">
        SELECT
            ei.`id`AS exam_id,
            ei.`project_id`,
            p.project_name,
            p.semester,
            ei.`name`,
            ei.`duration`,
            ei.`total_score`,
            ei.`pass_score`,
            ei.`start_time` AS exam_start_time,
            ei.`end_time` AS exam_end_time,
            es.`id` AS es_id,
            es.`exam_id`,
            es.`student_id`,
            es.`score`,
            es.`ai_score`,
            es.`start_time`,
            es.`end_time`
        FROM ExamInfo ei
            LEFT JOIN Exam_student es
                ON ei.`id`=es.`exam_id`
            LEFT JOIN project p
                ON p.id=ei.project_id
        WHERE ei.`project_id`=#{projectId};
    </select>

    <select id="selectExamWithStudentDtoById" resultMap="ExamWithStudentDto">
        SELECT
            ei.`id`AS exam_id,
            ei.`project_id`,
            p.project_name,
            p.semester,
            ei.`name`,
            ei.`duration`,
            ei.`total_score`,
            ei.`pass_score`,
            ei.`start_time` AS exam_start_time,
            ei.`end_time` AS exam_end_time,
            es.`id` AS es_id,
            es.`exam_id`,
            es.`student_id`,
            es.`score`,
            es.`ai_score`,
            es.`start_time`,
            es.`end_time`
        FROM ExamInfo ei
            LEFT JOIN Exam_student es
                ON ei.`id`=es.`exam_id`
            LEFT JOIN project p
                ON p.id=ei.project_id
        WHERE ei.`id`=#{examId};
    </select>

    <delete id="deleteExamInfoByExamId">
        DELETE FROM ExamInfo WHERE id=#{id}
    </delete>

    <select id="selectExamStudentVoByExamId" resultMap="ExamStudentVo">
        SELECT
            es.id,
            es.exam_id,
            s.id AS s_id,
            s.student_id,
            s.student_name,
            es.score,
            es.ai_score,
            es.start_time,
            es.end_time
        FROM Exam_student es LEFT JOIN Student s ON es.student_id=s.id
        WHERE es.exam_id=#{examId}
        ORDER BY s.student_id
        LIMIT #{offset},#{pageSize}
    </select>

    <select id="selectEsIdByExamId" resultType="java.lang.Long">
        SELECT
            es.id
        FROM Exam_student es LEFT JOIN Student s ON es.student_id=s.id
        WHERE es.exam_id=#{examId}
        ORDER BY s.student_id
    </select>

    <select id="selectExamStudentVoByEsId" resultMap="ExamStudentVo">
        SELECT
            es.id,
            es.exam_id,
            s.id AS s_id,
            s.student_id,
            s.student_name,
            es.score,
            es.ai_score,
            es.start_time,
            es.end_time,
            es.remark
        FROM Exam_student es LEFT JOIN Student s ON es.student_id=s.id
        WHERE es.id=#{esId}
    </select>

    <select id="selectExamStudentPaper" resultMap="ExamPaper">
        SELECT `id`, `es_id`, `ques_type`, `order`, `total_score`, `score`, `title`, `options_string`,
               `answer`, `knowledge_str`, `response`, `ai_score`, `payload_str`
        FROM Exam_paper
        WHERE es_id=#{esId}
        ORDER BY `ques_type`, `order`
    </select>

    <update id="updateExamPaper">
        UPDATE Exam_paper SET response=#{response} WHERE id=#{id}
    </update>

    <update id="updateQuesScore">
        UPDATE Exam_paper SET `score`=#{score} WHERE id=#{quesId}
    </update>

    <update id="updateQuesAiScore">
        UPDATE Exam_paper SET `ai_score`=#{aiScore},
                              `score`=#{aiScore},
                              `payload_str`=#{payloadStr}
                          WHERE id=#{quesId}
    </update>

    <update id="batchUpdateQuesAiScore">
        <foreach collection="list" item="item" separator=";">
            UPDATE Exam_paper
            SET
                `ai_score`=#{item.aiScore},
                `score`=#{item.aiScore},
                `payload_str`=#{item.payloadStr}
            WHERE id = #{item.id}
        </foreach>
    </update>

    <update id="updateEsScoreAndRemark">
        UPDATE Exam_student SET score=#{score},
                                remark=#{remark}
                            WHERE id=#{esId}
    </update>

    <update id="updateEsScore">
        UPDATE Exam_student SET score=#{score}
        WHERE id=#{esId}
    </update>

    <update id="updateEsAiScore">
        UPDATE Exam_student SET ai_score=#{aiScore}, score=#{aiScore}
        WHERE id=#{esId}
    </update>
    
    <select id="selectStudentExamCourse" resultMap="ExamCourseVo">
        SELECT
            p.id,
            p.project_name,
            p.semester,
            p.cover,
            p.create_time
        FROM project p
                 LEFT JOIN ExamInfo e ON p.id=e.project_id
                 LEFT JOIN Exam_student es ON e.id=es.exam_id
        WHERE es.student_id=#{studentId}
          AND p.version=4
          AND p.is_delete=0
        GROUP BY p.id
        ORDER BY create_time;
    </select>

    <select id="selectExamWithStudentDtoByStudent" resultMap="ExamWithStudentDto">
        SELECT
            ei.`id`AS exam_id,
            ei.`project_id`,
            p.project_name,
            p.semester,
            ei.`name`,
            ei.`duration`,
            ei.`total_score`,
            ei.`pass_score`,
            ei.`start_time` AS exam_start_time,
            ei.`end_time` AS exam_end_time,
            es.`id` AS es_id,
            es.`exam_id`,
            es.`student_id`,
            es.`score`,
            es.`ai_score`,
            es.`start_time`,
            es.`end_time`
        FROM ExamInfo ei
                 LEFT JOIN project p ON p.id=ei.`project_id`
                 LEFT JOIN Exam_student es ON ei.id=es.exam_id
        WHERE ei.project_id=#{projectId} AND es.student_id=#{studentId};
    </select>

    <select id="selectExamWithStudentDtoByEsId" resultMap="ExamWithStudentDto">
        SELECT
            ei.`id`AS exam_id,
            ei.`project_id`,
            p.project_name,
            p.semester,
            ei.`name`,
            ei.`duration`,
            ei.`total_score`,
            ei.`pass_score`,
            ei.`start_time` AS exam_start_time,
            ei.`end_time` AS exam_end_time,
            es.`id` AS es_id,
            es.`exam_id`,
            es.`student_id`,
            es.`score`,
            es.`ai_score`,
            es.`start_time`,
            es.`end_time`
        FROM ExamInfo ei
                 LEFT JOIN project p ON p.id=ei.`project_id`
                 LEFT JOIN Exam_student es ON ei.id=es.exam_id
        WHERE es.id=#{esId};
    </select>

    <update id="updateExamStudentStartTime">
        UPDATE Exam_student SET `start_time`=#{startTime} WHERE id=#{esId}
    </update>

    <update id="updateExamStudentEndTime">
        UPDATE Exam_student SET `end_time`=#{endTime} WHERE id=#{esId}
    </update>
</mapper>