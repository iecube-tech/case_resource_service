<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iecube.community.model.EMDV4Project.EMDV4Analysis.mapper.AnalysisProgressMapper">

    <resultMap id="AnalysisProgress" type="com.iecube.community.model.EMDV4Project.EMDV4Analysis.entity.AnalysisProgress">
        <result column="project_id" property="projectId"></result>
        <result column="total_count" property="totalCount"></result>
        <result column="completed_count" property="completedCount"></result>
        <result column="create_time" property="createTime"></result>
        <result column="update_time" property="updateTime"></result>
    </resultMap>

    <resultMap id="AnalysisProgressData" type="com.iecube.community.model.EMDV4Project.EMDV4Analysis.entity.AnalysisProgressData">
        <result column="ap_id" property="apId"></result>
        <result column="pt_id" property="ptId"></result>
        <result column="ps_id" property="psId"></result>
        <result column="student_id" property="studentId"></result>
    </resultMap>

    <resultMap id="AnalysisInfo" type="com.iecube.community.model.EMDV4Project.EMDV4Analysis.vo.AnalysisInfo">
        <result property="projectName" column="project_name"></result>
        <result property="semester" column="semester"></result>
        <result property="studentCount" column="student_count"></result>
        <result property="classNames" column="class_names"></result>
        <result property="updateTime" column="progress_update_time"></result>
    </resultMap>

    <resultMap id="AnalysisCatalog" type="com.iecube.community.model.EMDV4Project.EMDV4Analysis.dto.AnalysisCatalog">
        <result column="project_name" property="projectName"></result>
        <result column="start_time" property="startTime"></result>
        <result column="end_time" property="endTime"></result>
        <result column="apd_data" property="apdData"></result>
        <result column="stu_num" property="stuNum"></result>
    </resultMap>

    <insert id="createAP">
        INSERT INTO AP_analysis_progress (`id`,`project_id`,`total_count`,`completed_count`, `finished`,
                                          `percent`,`message`,`create_time`,`update_time`)
        VALUES (#{id}, #{projectId}, #{totalCount}, #{completedCount}, #{finished},
                #{percent}, #{message}, #{createTime}, #{updateTime})
    </insert>

    <select id="getAPById" resultMap="AnalysisProgress">
        SELECT `id`,`project_id`,`total_count`,`completed_count`, `finished`,
               `percent`,`message`,`create_time`,`update_time`
        FROM AP_analysis_progress
        WHERE id=#{id}
    </select>

    <select id="getApLatestByProjectId" resultMap="AnalysisProgress">
        SELECT `id`,`project_id`,`total_count`,`completed_count`, `finished`,
               `percent`,`message`,`create_time`,`update_time`
        FROM AP_analysis_progress
        WHERE project_id=#{projectId} ORDER BY create_time DESC LIMIT 1
    </select>

    <select id="getApLatestSuccessByProjectId" resultMap="AnalysisProgress">
        SELECT `id`,`project_id`,`total_count`,`completed_count`, `finished`,
               `percent`,`message`,`create_time`,`update_time`
        FROM AP_analysis_progress
        WHERE project_id=#{projectId} AND finished=1 AND percent=100 ORDER BY create_time DESC LIMIT 1
    </select>

    <update id="updateAPById">
        UPDATE AP_analysis_progress SET completed_count=#{completedCount},
                                        finished=#{finished},
                                        percent=#{percent},
                                        message=#{message},
                                        update_time=#{updateTime}
                                    WHERE id=#{id}
    </update>

    <insert id="createAPD">
        INSERT INTO AP_data (`id`,`ap_id`,`type`, `data`, `pt_id`, `ps_id`, `student_id`)
        VALUES (#{id}, #{apId}, #{type}, #{data}, #{ptId}, #{psId}, #{studentId})
    </insert>

    <insert id="batchCreatAPD">
        INSERT INTO AP_data (`id`,`ap_id`,`type`, `data`, `pt_id`, `ps_id`, `student_id`)
        VALUES
        <foreach collection="list" separator="," item="item">
            (#{item.id}, #{item.apId}, #{item.type}, #{item.data}, #{item.ptId}, #{item.psId}, #{item.studentId})
        </foreach>
    </insert>


    <select id="getAPD" resultMap="AnalysisProgressData">
        SELECT `id`,`ap_id`,`type`, `data`,  `pt_id`, `ps_id`, `student_id`
        FROM AP_data
        WHERE `ap_id`=#{apId} AND type=#{type}
    </select>

    <select id="getAPDWithPtId" resultMap="AnalysisProgressData">
        SELECT `id`,`ap_id`,`type`, `data`, `pt_id`, `ps_id`, `student_id`
        FROM AP_data
        WHERE `ap_id`=#{apId} AND type=#{type} AND pt_id=#{ptId}
    </select>

    <select id="getAPDWithStudentId" resultMap="AnalysisProgressData">
        SELECT `id`,`ap_id`,`type`, `data`, `pt_id`, `ps_id`, `student_id`
        FROM AP_data
        WHERE `ap_id`=#{apId} AND type=#{type} AND student_id=#{studentId}
    </select>

    <select id="getAPDWithPtIdAndPsId" resultMap="AnalysisProgressData">
        SELECT `id`,`ap_id`,`type`, `data`, `pt_id`, `ps_id`, `student_id`
        FROM AP_data
        WHERE `ap_id`=#{apId} AND type=#{type} AND pt_id=#{ptId} AND ps_id=#{psId}
    </select>

    <select id="getAnalysisInfo" resultMap="AnalysisInfo" >
        SELECT
            p.project_name,
            p.semester,
            -- 核心新增：统计该项目关联的学生数量（去重，避免重复关联）
            IFNULL(COUNT(DISTINCT ps.student_id), 0) AS student_count,
            -- 原有：拼接关联班级名
            IFNULL(GROUP_CONCAT(DISTINCT cg.name SEPARATOR ','), '') AS class_names,
            -- 进度表字段（可选保留，按需调整）
            ap.percent AS progress_percent,
            ap.finished AS progress_finished,
            ap.create_time AS progress_create_time,
            ap.update_time AS progress_update_time
        FROM
            project p
-- 关联项目-学生中间表（LEFT JOIN 保证无学生时计数为0）
                LEFT JOIN EMDV4_projectStudent ps ON p.id = ps.project_id
-- 关联学生表
                LEFT JOIN Student s ON ps.student_id = s.id
-- 关联班级表
                LEFT JOIN class_and_grade cg ON s.student_class = cg.id
-- 关联进度表（仅匹配最新完成的1条记录）
                LEFT JOIN (
                SELECT * FROM AP_analysis_progress
                WHERE
                    project_id = #{projectId}
                  AND percent = 100
                  AND finished = 1
                ORDER BY create_time DESC
                    LIMIT 1
            ) ap ON p.id = ap.project_id
        WHERE
            p.id = #{projectId}  -- 目标项目ID
        GROUP BY
            -- 分组字段需包含所有非聚合字段
            p.id, p.project_name, p.semester,
            ap.percent, ap.finished, ap.create_time,ap.update_time;
    </select>

    <select id="getStuName" resultType="java.lang.String">
        SELECT s.student_name
        FROM EMDV4_projectStudent ps
            LEFT JOIN Student s ON ps.student_id=s.id
        WHERE ps.project_id=#{projectId} AND s.student_id=#{studentId}
    </select>

    <select id="getEmdv4ProjectIdInTime" resultType="java.lang.Integer">
        SELECT id FROM `project`
                  WHERE version >=4
                    AND NOW() BETWEEN DATE_ADD(start_time,INTERVAL 1 DAY) AND DATE_ADD(end_time,INTERVAL 1 DAY)
                    AND is_delete=0
    </select>

    <select id="getCreatorAnalysisCatalogs" resultMap="AnalysisCatalog">
        WITH RECURSIVE APDATA AS (
            SELECT t1.project_id, ad.`data` AS apd_data
            FROM AP_analysis_progress t1
                     LEFT JOIN AP_data ad ON t1.id=ad.ap_id
            WHERE t1.update_time = (
                -- 子查询直接取当前project_id的最新时间，无需分组
                SELECT MAX(update_time)
                FROM AP_analysis_progress t2
                WHERE t2.project_id = t1.project_id
            )
              AND ad.`type`="t_overview_overview"
        )
        SELECT
            p.id,
            p.project_name,
            p.semester,
            p.start_time,
            p.end_time,  -- 查询project表的所有字段
            apd.apd_data,
            COALESCE(SUM(pt.classhour), 0) AS classhour,  -- 求和，无数据时返回0
            COALESCE(COUNT(DISTINCT ps.id), 0) AS stu_num
        FROM project p
                 LEFT JOIN APDATA apd ON p.id=apd.project_id
                 LEFT JOIN EMDV4_projectTask pt ON p.id = pt.project_id  -- 关联两张表
                 LEFT JOIN EMDV4_projectStudent ps ON p.id=ps.project_id
        WHERE p.creator=#{creator} AND p.version=4 AND p.is_delete=0
        -- WHERE p.id=246
        GROUP BY
            p.id, apd.project_id, apd.apd_data  -- 按project的主键分组
    </select>

    <select id="getAnalysisCatalog" resultMap="AnalysisCatalog">
        WITH RECURSIVE APDATA AS (
            SELECT t1.project_id, ad.`data` AS apd_data
            FROM AP_analysis_progress t1
                     LEFT JOIN AP_data ad ON t1.id=ad.ap_id
            WHERE t1.update_time = (
                -- 子查询直接取当前project_id的最新时间，无需分组
                SELECT MAX(update_time)
                FROM AP_analysis_progress t2
                WHERE t2.project_id = t1.project_id
            )
              AND ad.`type`="t_overview_overview"
        )
        SELECT
            p.id,
            p.project_name,
            p.semester,
            p.start_time,
            p.end_time,  -- 查询project表的所有字段
            apd.apd_data,
            COALESCE(SUM(pt.classhour), 0) AS classhour,  -- 求和，无数据时返回0
            COALESCE(COUNT(DISTINCT ps.id), 0) AS stu_num
        FROM project p
                 LEFT JOIN APDATA apd ON p.id=apd.project_id
                 LEFT JOIN EMDV4_projectTask pt ON p.id = pt.project_id  -- 关联两张表
                 LEFT JOIN EMDV4_projectStudent ps ON p.id=ps.project_id
        WHERE p.id=#{projectId}
        GROUP BY
            p.id, apd.project_id, apd.apd_data  -- 按project的主键分组
    </select>

</mapper>